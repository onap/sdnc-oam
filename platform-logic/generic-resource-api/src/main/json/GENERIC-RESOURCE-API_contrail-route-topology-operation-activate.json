[{"id":"44e2a591.0adfcc","type":"dgstart","name":"DGSTART","outputs":1,"x":130,"y":65,"z":"64165859.65c218","wires":[["9d11986f.fe6c88"]]},{"id":"9d11986f.fe6c88","type":"service-logic","name":"GENERIC-RESOURCE-API ${project.version}","module":"GENERIC-RESOURCE-API","version":"${project.version}","comments":"","xml":"<service-logic xmlns='http://www.onap.org/sdnc/svclogic' xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xsi:schemaLocation='http://www.onap.org/sdnc/svclogic ./svclogic.xsd' module='GENERIC-RESOURCE-API' version='${project.version}'>","outputs":1,"x":276.2380828857422,"y":139.95239353179932,"z":"64165859.65c218","wires":[["25a64b97.aaff84"]]},{"id":"25a64b97.aaff84","type":"method","name":"contrail-route-topology-operation-activate","xml":"<method rpc='contrail-route-topology-operation-activate' mode='sync'>\n","comments":"","outputs":1,"x":356.1548500061035,"y":209.1904420852661,"z":"64165859.65c218","wires":[["e75d32c1.7f5e3"]]},{"id":"e75d32c1.7f5e3","type":"block","name":"block : atomic","xml":"<block atomic=\"true\">","atomic":"true","comments":"","outputs":1,"x":264.4761848449707,"y":352.523784160614,"z":"64165859.65c218","wires":[["3c3c6bb5.b74fe4","748de0e2.cf35d","5d6b0eae.8b9ab","7e74e9f3.a6ed98","dd3b156a.4c09b8","a48e302.6f113d","bacf284d.e94b18","e41c133b.c89b1","b10213e8.7105b","6f67eab4.30b314","c4b97b0e.a9a448","82a00528.729748","3396a245.5af4be","4afec706.648e68","6e8ca02f.7313","54889c95.317884","c2672028.9a192","bc559c11.5308","a6675806.e2dc08","f8a3e8b0.ff98a8","f2b08893.418cf8","f43488c4.18e4b8"]]},{"id":"748de0e2.cf35d","type":"set","name":"set tmp.ar.self-link","xml":"<set>\n<parameter name='tmp.ar.self-link' value=\"`'restconf/config/GENERIC-RESOURCE-API:contrail-route-allotted-resources/contrail-route-allotted-resource/'\n + $tmp.ar.allotted-resource-id\n + '/allotted-resource-data/contrail-route-topology/'` \" />\n\n","comments":"","x":526.7380561828613,"y":326.3333215713501,"z":"64165859.65c218","wires":[]},{"id":"3c3c6bb5.b74fe4","type":"set","name":"set tmp.ar.allotted-resource-id,etc","xml":"<set>\n<parameter name='tmp.ar.allotted-resource-id' value='`$contrail-route-topology-operation-input.allotted-resource-information.allotted-resource-id`' />\n<parameter name='tmp.ar.parent-service-instance-id' value='`$contrail-route-topology-operation-input.allotted-resource-information.parent-service-instance-id`' />\n\n\n\n","comments":"","x":573.9973182678223,"y":292.5925874710083,"z":"64165859.65c218","wires":[]},{"id":"5d6b0eae.8b9ab","type":"execute","name":"execute Properties - pull properties file","xml":"<execute plugin='org.onap.ccsdk.plugins.prop.PropertiesNode' method='readProperties' >\n    <parameter name='fileName' value='%SDNC_CONFIG_DIR%/generic-resource-api-dg.properties' />\n    <parameter name='contextPrefix' value='prop' />\n","comments":"","outputs":1,"x":595.8505554199219,"y":358.23155403137207,"z":"64165859.65c218","wires":[[]]},{"id":"dd3b156a.4c09b8","type":"execute","name":"execute RestApiCallNode - Get AR by id","xml":"<execute plugin='org.onap.ccsdk.plugins.restapicall.RestapiCallNode' method='sendRequest' >\n    <parameter name='restapiUrl' value='`$prop.controller.url + $tmp.ar-url`' />\n    <parameter name='restapiUser' value='`$prop.controller.user`' />\n    <parameter name='restapiPassword' value='`$prop.controller.pwd`' />\n    <parameter name='format' value='json' />\n    <parameter name='httpMethod' value='GET' />\n    <parameter name=\"responsePrefix\" value=\"mdsal-ar\" />\n\n","comments":"","outputs":1,"x":600.6616058349609,"y":500.45952796936035,"z":"64165859.65c218","wires":[["2d1118d7.ca9798","1d99ce09.530022"]]},{"id":"7e74e9f3.a6ed98","type":"execute","name":"generate allotted-resource url","xml":"<execute plugin='org.onap.ccsdk.sli.core.slipluginutils.SliStringUtils' method='replace' >\n    <parameter name=\"source\" value=\"`$prop.restapi.cr-allottedresource`\"/>\n    <parameter name=\"outputPath\" value=\"tmp.ar-url\"/>\n    <parameter name=\"target\" value=\"{allotted-resource-id}\"/>\n    <parameter name=\"replacement\" value=\"`$tmp.ar.allotted-resource-id`\"/>\n","comments":"","outputs":1,"x":561.0648460388184,"y":422.01722526550293,"z":"64165859.65c218","wires":[[]]},{"id":"2d1118d7.ca9798","type":"success","name":"success","xml":"<outcome value='success'>\n","comments":"","outputs":1,"x":845.9577102661133,"y":501.26734161376953,"z":"64165859.65c218","wires":[["ea375293.82727"]]},{"id":"ea375293.82727","type":"block","name":"block: atomic","xml":"<block atomic=\"true\">\n","atomic":"false","comments":"","outputs":1,"x":1014.9577140808105,"y":499.7672424316406,"z":"64165859.65c218","wires":[["d774b31f.c823"]]},{"id":"d774b31f.c823","type":"switchNode","name":"switch cr length","xml":"<switch test='`$mdsal-ar.contrail-route-allotted-resource_length`'>\n","comments":"","outputs":1,"x":1225.814956665039,"y":499.3863716125488,"z":"64165859.65c218","wires":[["3663a4b3.12200c","5fbd0011.d76a1"]]},{"id":"3663a4b3.12200c","type":"other","name":"outcome 1","xml":"<outcome value='1'>\n","comments":"","outputs":1,"x":1415.1482620239258,"y":499.3863296508789,"z":"64165859.65c218","wires":[["ef8b2c8f.54ea4"]]},{"id":"5800ba19.309e44","type":"set","name":"set ar from get","xml":"<set>\n<parameter name='ar.' value='$mdsal-ar.contrail-route-allotted-resource[0].' />\n","comments":"","x":1891.1962203979492,"y":492.62452602386475,"z":"64165859.65c218","wires":[]},{"id":"ef8b2c8f.54ea4","type":"block","name":"block: atomic","xml":"<block atomic='true'>\n","atomic":"false","comments":"","outputs":1,"x":1599.6721515655518,"y":496.29116344451904,"z":"64165859.65c218","wires":[["5800ba19.309e44","16951cf9.185633","5548694b.3db0b8","73094ec5.b6eab"]]},{"id":"16951cf9.185633","type":"set","name":"set oper-status","xml":"<set>\n<parameter name='sz-ar.allotted-resource-data.allotted-resource-oper-status.last-action' value='`$sz-ar.allotted-resource-data.allotted-resource-operation-information.request-information.request-action`' />\n<parameter name='sz-ar.allotted-resource-data.allotted-resource-oper-status.last-rpc-action' value='`$sz-ar.allotted-resource-status.rpc-action`' />\n<parameter name='sz-ar.allotted-resource-data.allotted-resource-oper-status.last-svc-request-id' value='`$sz-ar.allotted-resource-data.allotted-resource-operation-information.sdnc-request-header.svc-request-id`' />\n\n","comments":"","x":1899.1961479187012,"y":556.719669342041,"z":"64165859.65c218","wires":[]},{"id":"4cd61be.86e0ce4","type":"comment","name":"GET contrail-route-allotted-resource from mdsal","info":"","comments":"","x":616.8148498535156,"y":466.3386821746826,"z":"64165859.65c218","wires":[]},{"id":"5548694b.3db0b8","type":"switchNode","name":"switch order-status","xml":"<switch test='`$ar.allotted-resource-data.allotted-resource-oper-status.order-status`'>\n","comments":"","outputs":1,"x":1907.196002960205,"y":523.6244812011719,"z":"64165859.65c218","wires":[["3a1379d8.d399a6","b6f3ab65.fc2188"]]},{"id":"3a1379d8.d399a6","type":"outcome","name":"outcome Created","xml":"<outcome value='Created'>\n","comments":"","outputs":1,"x":2129.0339584350586,"y":507.7197847366333,"z":"64165859.65c218","wires":[["84ee09a1.dc5b98"]]},{"id":"b6f3ab65.fc2188","type":"outcome","name":"outcome Other","xml":"<outcome value='Other'>\n","comments":"","outputs":1,"x":2142.8436737060547,"y":538.0531902313232,"z":"64165859.65c218","wires":[["fcf09d0b.021fd"]]},{"id":"fcf09d0b.021fd","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"500\" />\n    <parameter name=\"error-message\" \n    value=\"`'Existing contrail-route-allotted-resource with order status of ' + $ar.allotted-resource-data.allotted-resource-oper-status.order-status + ', expecting Created.'`\" />\n","comments":"","x":2383.462423324585,"y":540.9577798843384,"z":"64165859.65c218","wires":[]},{"id":"73094ec5.b6eab","type":"set","name":"save backup copy of mdsal-ar for rollback","xml":"<set>\n<parameter name='bk-cr-ar' value='$mdsal-ar.' />\n","comments":"","x":1979.0532722473145,"y":459.4340181350708,"z":"64165859.65c218","wires":[]},{"id":"d9e02c4.1b7dcd","type":"comment","name":"Create urls for restapi","info":"","comments":"","x":531.9576530456543,"y":391.62435245513916,"z":"64165859.65c218","wires":[]},{"id":"d9fc2f4b.0e8a1","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"404\" />\n    <parameter name=\"error-message\" value=\"Error: Contrail Route not found\" />\n    \n","comments":"","x":1601.666997909546,"y":642.3333854675293,"z":"64165859.65c218","wires":[]},{"id":"1d99ce09.530022","type":"other","name":"other","xml":"<outcome value='Other'>\n","comments":"","outputs":1,"x":837.809513092041,"y":536.3334264755249,"z":"64165859.65c218","wires":[["a5703b2e.575d28"]]},{"id":"a5703b2e.575d28","type":"block","name":"block: atomic","xml":"<block atomic=\"true\">\n","atomic":"false","comments":"","outputs":1,"x":1017.8094635009766,"y":536.9999771118164,"z":"64165859.65c218","wires":[["d9fc2f4b.0e8a1"]]},{"id":"a48e302.6f113d","type":"set","name":"set ar data","xml":"<set>\n<parameter name='ar.allotted-resource-id' value=\"`$tmp.ar.allotted-resource-id` \" />\n<parameter name='ar.allotted-resource-status.action' value=\"`$contrail-route-topology-operation-input.request-information.request-action` \" />\n<parameter name='ar.allotted-resource-status.rpc-name' value=\"contrail-route-topology-operation\" />\n<parameter name='ar.allotted-resource-status.rpc-action' value=\"`$contrail-route-topology-operation-input.sdnc-request-header.svc-action` \" />\n<parameter name='ar.allotted-resource-data.allotted-resource-operation-information.request-information.' value=\"`$contrail-route-topology-operation-input.request-information.` \" />\n<parameter name='ar.allotted-resource-data.allotted-resource-operation-information.sdnc-request-header.' value=\"`$contrail-route-topology-operation-input.sdnc-request-header.` \" />\n<parameter name='ar.allotted-resource-data.allotted-resource-operation-information.service-information.' value=\"`$contrail-route-topology-operation-input.service-information.` \" />\n<parameter name='ar.allotted-resource-data.allotted-resource-operation-information.allotted-resource-information.' value=\"`$contrail-route-topology-operation-input.allotted-resource-information.` \" />\n<parameter name='ar.allotted-resource-data.allotted-resource-operation-information.contrail-route-request-input.' value=\"`$contrail-route-topology-operation-input.contrail-route-request-input.` \" />\n","comments":"","x":510.66661071777344,"y":537.5237884521484,"z":"64165859.65c218","wires":[]},{"id":"5fbd0011.d76a1","type":"other","name":"other","xml":"<outcome value='Other'>\n","comments":"","outputs":1,"x":1403.4762153625488,"y":536.6666898727417,"z":"64165859.65c218","wires":[["d9fc2f4b.0e8a1"]]},{"id":"84ee09a1.dc5b98","type":"block","name":"block","xml":"<block>\n","atomic":"false","comments":"","outputs":1,"x":2367.333469390869,"y":506.66669750213623,"z":"64165859.65c218","wires":[[]]},{"id":"6b294610.d0fca8","type":"not-found","name":"not found","xml":"<outcome value='not-found'>\n","comments":"","outputs":1,"x":855.2856597900391,"y":795.7143956422806,"z":"64165859.65c218","wires":[["8bf366e0.30e6f8"]]},{"id":"a68172da.f1ef3","type":"get-resource","name":"get AnAI - l3-network by network-id","xml":"<get-resource plugin=\"org.onap.ccsdk.sli.adaptors.aai.AAIService\" \n\tresource=\"l3-network\" \n\t\tkey=\"l3-network.network-id = $ar.allotted-resource-data.contrail-route-topology.contrail-route-assignments.source-network.network-id\" \n\t\tlocal-only=\"false\" \n\t\tpfx=\"aai.src-network\">\n","comments":"","outputs":1,"x":578.484001159668,"y":806.9609127044678,"z":"64165859.65c218","wires":[["5f9b62c9.68560c","6b294610.d0fca8","e4999668.493168"]]},{"id":"5f9b62c9.68560c","type":"failure","name":"failure","xml":"<outcome value='failure'>\n","comments":"","outputs":1,"x":848.0077667236328,"y":830.1989995241165,"z":"64165859.65c218","wires":[["8bf366e0.30e6f8"]]},{"id":"8bf366e0.30e6f8","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name=\"error-code\" value=\"500\" />\n\t<parameter name=\"error-message\" value=\"`'Error retrieving source network with network-id=' + $ar.allotted-resource-data.contrail-route-topology.contrail-route-assignments.source-network.network-id + ' from AnAI'`\" />","comments":"","x":1000.1187286376953,"y":826.4212285280228,"z":"64165859.65c218","wires":[]},{"id":"e4999668.493168","type":"success","name":"success","xml":"<outcome value='success'>\n","comments":"","outputs":1,"x":853.2857208251953,"y":861.7143956422806,"z":"64165859.65c218","wires":[["b98ab8b5.b478e8"]]},{"id":"b98ab8b5.b478e8","type":"block","name":"block : atomic","xml":"<block atomic=\"true\">","atomic":"true","outputs":1,"x":1005.9522857666016,"y":860.0477238893509,"z":"64165859.65c218","wires":[[]]},{"id":"ff8773cb.3c81e","type":"comment","name":"GET source network from AAI","info":"","comments":"","x":556.7142181396484,"y":775.7143898010254,"z":"64165859.65c218","wires":[]},{"id":"14eb9a5f.2b7306","type":"not-found","name":"not found","xml":"<outcome value='not-found'>\n","comments":"","outputs":1,"x":873,"y":1059.4287095069885,"z":"64165859.65c218","wires":[["805cd670.1362a8"]]},{"id":"bacf284d.e94b18","type":"get-resource","name":"get AnAI - l3-network by network-id","xml":"<get-resource plugin=\"org.onap.ccsdk.sli.adaptors.aai.AAIService\" \n\tresource=\"l3-network\" \n\t\tkey=\"l3-network.network-id = $ar.allotted-resource-data.contrail-route-topology.contrail-route-assignments.dest-network.network-id\" \n\t\tlocal-only=\"false\" \n\t\tpfx=\"aai.dest-network\">\n","comments":"","outputs":1,"x":601.6269226074219,"y":1066.960970401764,"z":"64165859.65c218","wires":[["89010b42.75b1b8","14eb9a5f.2b7306","e2f3ea25.4379d8"]]},{"id":"89010b42.75b1b8","type":"failure","name":"failure","xml":"<outcome value='failure'>\n","comments":"","outputs":1,"x":865.7221069335938,"y":1093.9133133888245,"z":"64165859.65c218","wires":[["805cd670.1362a8"]]},{"id":"805cd670.1362a8","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name=\"error-code\" value=\"500\" />\n\t<parameter name=\"error-message\" value=\"`'Error retrieving destination network with network-id=' + $ar.allotted-resource-data.contrail-route-topology.contrail-route-assignments.source-network.network-id + ' from AnAI'`\" />","comments":"","x":1017.8330688476562,"y":1090.1355423927307,"z":"64165859.65c218","wires":[]},{"id":"e2f3ea25.4379d8","type":"success","name":"success","xml":"<outcome value='success'>\n","comments":"","outputs":1,"x":875.5715103149414,"y":1128.2857780456543,"z":"64165859.65c218","wires":[["ae8077d1.7e13b8"]]},{"id":"ae8077d1.7e13b8","type":"block","name":"block : atomic","xml":"<block atomic=\"true\">","atomic":"true","outputs":1,"x":1028.2380752563477,"y":1126.6191062927246,"z":"64165859.65c218","wires":[[]]},{"id":"369a7d5c.fb1bf2","type":"comment","name":"GET dest network from AAI","info":"","comments":"","x":574.4285430908203,"y":1035.1429624557495,"z":"64165859.65c218","wires":[]},{"id":"e41c133b.c89b1","type":"set","name":"set policy fq-name","xml":"<set>\n<parameter name='tmp.fq-name' value=\"`$ar.allotted-resource-data.contrail-route-topology.contrail-route-assignments.fq-name` \" />\n","comments":"","x":527.4286270141602,"y":852.8571510314941,"z":"64165859.65c218","wires":[]},{"id":"b10213e8.7105b","type":"set","name":"set cloud-region-id for input to contrail","xml":"<set>\n<parameter name='cloud-region-id' value='`$tmp.ar.cloud-region-id`' />\n","comments":"","x":589.4233093261719,"y":886.9469985961914,"z":"64165859.65c218","wires":[]},{"id":"82a00528.729748","type":"execute","name":"execute Contrail API apply network policy to source network","xml":"<execute plugin='org.onap.ccsdk.sli.plugins.contrail.ContrailAdaptor' method='sendContrailRequest' emitsOutcome='true' >\n<parameter name='api-name' value='network-policy' />\n<parameter name='api-action' value='apply' />\n<parameter name='resp-prefix' value='contrailResp' />\n<parameter name='cloud-region-id' value='`$tmp.ar.cloud-region-id`' />\n<parameter name='contrail-network-policy-id' value='`$ar-assignments.contrail-id`' />\n<parameter name='contrail-network-policy-fq-name' value='`$ar-assignments.contrail-fq-name`' />\n<parameter name='contrail-virtual-network-id' value='`$aai.src-network.contrail-network-fqdn`' />\n\n","comments":"","outputs":1,"x":665.6138305664062,"y":959.9471964836121,"z":"64165859.65c218","wires":[["bf44764e.6b5a08","d0dde1cb.d90ed"]]},{"id":"bf44764e.6b5a08","type":"success","name":"success","xml":"<outcome value='success'>\n","comments":"","outputs":1,"x":1021.2803268432617,"y":960.3754234313965,"z":"64165859.65c218","wires":[["12a9c022.986f1"]]},{"id":"d0dde1cb.d90ed","type":"failure","name":"failure","xml":"<outcome value='failure'>\n","comments":"","outputs":1,"x":1019.3756484985352,"y":993.3753631971776,"z":"64165859.65c218","wires":[["84f2d70e.48c6a8"]]},{"id":"84f2d70e.48c6a8","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"500\" />\n    <parameter name=\"error-message\" value=\"Failed to apply policy in Contrail to source network\" />\n","comments":"","x":1179.280418395996,"y":992.7087297439575,"z":"64165859.65c218","wires":[]},{"id":"12a9c022.986f1","type":"block","name":"block","xml":"<block>\n","atomic":"false","comments":"","outputs":1,"x":1173.4708099365234,"y":961.042148437351,"z":"64165859.65c218","wires":[[]]},{"id":"6f67eab4.30b314","type":"set","name":"set ar-assignments","xml":"<set>\n<parameter name='ar-assignments.' value=\"`$ar.allotted-resource-data.contrail-route-topology.contrail-route-assignments.`\" />\n\n\n\n","comments":"","x":538,"y":572,"z":"64165859.65c218","wires":[]},{"id":"c4b97b0e.a9a448","type":"switchNode","name":"switch source-network.network-id","xml":"<switch test='`$ar.allotted-resource-data.contrail-route-topology.contrail-route-assignments.source-network.network-id`'>\n\n","comments":"","outputs":1,"x":582,"y":732,"z":"64165859.65c218","wires":[["5e9aa570.67bd9c","3c95f25.131720e"]]},{"id":"5e9aa570.67bd9c","type":"other","name":"Other","xml":"<outcome value='Other'>","comments":"","outputs":1,"x":938.0002174377441,"y":730.6663794517517,"z":"64165859.65c218","wires":[["15e26772.92ed49"]]},{"id":"3c95f25.131720e","type":"other","name":"NULL","xml":"<outcome value=''>","comments":"","outputs":1,"x":933.6670341491699,"y":693.6661796569824,"z":"64165859.65c218","wires":[["e75d9c15.8524a"]]},{"id":"c94aaa39.361bb8","type":"switchNode","name":"switch service-data.networks.network_length","xml":"<switch test='`$service-data.networks.network_length`'>\n","comments":"","outputs":1,"x":1329.8256530761719,"y":730.6822066307068,"z":"64165859.65c218","wires":[["31d38ee0.d6f1c2","91dd3bf.a1bacc8"]]},{"id":"31d38ee0.d6f1c2","type":"other","name":"outcome Null","xml":"<outcome value=''>\n","comments":"","outputs":1,"x":1618.8256530761719,"y":732.682267665863,"z":"64165859.65c218","wires":[["499747c7.a55a48"]]},{"id":"91dd3bf.a1bacc8","type":"other","name":"other","xml":"<outcome value='Other'>\n","comments":"","outputs":1,"x":1598.8256530761719,"y":767.682267665863,"z":"64165859.65c218","wires":[["af14b3c3.48097"]]},{"id":"15e26772.92ed49","type":"block","name":"block","xml":"<block>\n","atomic":"false","comments":"","outputs":1,"x":1072.111473083496,"y":731.1107840538025,"z":"64165859.65c218","wires":[["c94aaa39.361bb8"]]},{"id":"e75d9c15.8524a","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"500\" />\n    <parameter name=\"error-message\" value=\"Error activating contrail route.  Source network not found\" />\n","comments":"","x":1087.8004989624023,"y":694.3330821990967,"z":"64165859.65c218","wires":[]},{"id":"d046e6f6.0e2458","type":"comment","name":"Find tenant id/cloud region from source network","info":"","comments":"","x":619.4003219604492,"y":698.6663160324097,"z":"64165859.65c218","wires":[]},{"id":"46dda770.da6c38","type":"for","name":"for nidx..service-data.networks.network[]","xml":"<for index='nidx' start='0' end='`$service-data.networks.network_length`' >\n","comments":"","outputs":1,"x":2062.0000610351562,"y":768.0000228881836,"z":"64165859.65c218","wires":[["309cdf1e.a7927"]]},{"id":"af14b3c3.48097","type":"block","name":"block : atomic","xml":"<block atomic=\"true\">","atomic":"true","outputs":1,"x":1787.9841003417969,"y":768.1260228157043,"z":"64165859.65c218","wires":[["46dda770.da6c38"]]},{"id":"499747c7.a55a48","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"500\" />\n    <parameter name=\"error-message\" value=\"Error activating contrail route.  Source network not found\" />\n","comments":"","x":1800.4888000488281,"y":732.5555934906006,"z":"64165859.65c218","wires":[]},{"id":"309cdf1e.a7927","type":"switchNode","name":"switch networkid found","xml":"<switch test=\"`$service-data.networks.network[$nidx].network-id == $ar.allotted-resource-data.contrail-route-topology.contrail-route-assignments.source-network.network-id`\">\n\n","comments":"","outputs":1,"x":2354.5548706054688,"y":764.8891496658325,"z":"64165859.65c218","wires":[["849d5f32.c0a1d","8e8c972.e2a3368"]]},{"id":"ea225ffd.8fd5c","type":"set","name":"set tenantid and cloud region id","xml":"<set>\n<parameter name='tmp.ar.tenant-id' value='`$service-data.networks.network[$nidx].network-data.network-topology.tenant`' />\n<parameter name='tmp.ar.cloud-region-id' value='`$service-data.networks.network[$nidx].network-data.network-topology.aic-cloud-region`' />\n\n\n","comments":"","x":2942.2214736938477,"y":754.8891334533691,"z":"64165859.65c218","wires":[]},{"id":"d4059f44.0d602","type":"block","name":"block","xml":"<block>\n","atomic":"false","comments":"","outputs":1,"x":2704.2879848480225,"y":767.8891382217407,"z":"64165859.65c218","wires":[["ea225ffd.8fd5c","22a21cd1.407344"]]},{"id":"849d5f32.c0a1d","type":"outcomeTrue","name":"true","xml":"<outcome value='true'>\n","comments":"","outputs":1,"x":2548.821361541748,"y":767.8890008926392,"z":"64165859.65c218","wires":[["d4059f44.0d602"]]},{"id":"8e8c972.e2a3368","type":"other","name":"other","xml":"<outcome value='Other'>\n","comments":"","outputs":1,"x":2549.6209716796875,"y":805.8890037536621,"z":"64165859.65c218","wires":[["866adc09.2f017"]]},{"id":"866adc09.2f017","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"500\" />\n    <parameter name=\"error-message\" value=\"Error activating contrail route.  Source network not found\" />\n","comments":"","x":2727.6211280822754,"y":805.8890695571899,"z":"64165859.65c218","wires":[]},{"id":"22a21cd1.407344","type":"get-resource","name":"get-resource tenant","xml":"<get-resource plugin=\"org.onap.ccsdk.sli.adaptors.aai.AAIService\" \n\t\tresource=\"tenant\" \n\t\tkey=\"cloud-region.cloud-owner = 'att-aic' AND \n\t\t     cloud-region.cloud-region-id = $tmp.ar.cloud-region-id AND\n\t\t     tenant.tenant-id = $tmp.ar.tenant-id\"\n        pfx='aai.tenant' local-only='false' >\n\n","comments":"","outputs":1,"x":2916.688087463379,"y":790.888822555542,"z":"64165859.65c218","wires":[["9e49f002.0fb2d","9fd3ada.9523b5","38a0e1a6.0275de"]]},{"id":"9e49f002.0fb2d","type":"not-found","name":"not-found","xml":"<outcome value='not-found'>\n","comments":"","outputs":1,"x":3153.549415588379,"y":805.4999141693115,"z":"64165859.65c218","wires":[["e5c370f8.6038"]]},{"id":"9fd3ada.9523b5","type":"other","name":"other","xml":"<outcome value='Other'>\n","comments":"","outputs":1,"x":3148.8824424743652,"y":838.8332281112671,"z":"64165859.65c218","wires":[["e5c370f8.6038"]]},{"id":"e5c370f8.6038","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"500\" />\n    <parameter name=\"error-message\" value=\"Tenant not found in AAI\" />\n\n","comments":"","x":3323.058364868164,"y":826.8887872695923,"z":"64165859.65c218","wires":[]},{"id":"38a0e1a6.0275de","type":"success","name":"success","xml":"<outcome value='success'>\n","comments":"","outputs":1,"x":3149.058448791504,"y":773.9258785247803,"z":"64165859.65c218","wires":[["3e857a0c.1c9ed6"]]},{"id":"3e857a0c.1c9ed6","type":"block","name":"block : atomic","xml":"<block atomic=\"true\">","atomic":"true","outputs":1,"x":3329.058448791504,"y":771.9258785247803,"z":"64165859.65c218","wires":[["4c618c54.2a14d4"]]},{"id":"4c618c54.2a14d4","type":"set","name":"set tenant name","xml":"<set>\n<parameter name='tmp.ar.tenant-name' value='`$aai.tenant.tenant-name`' />\n\n\n","comments":"","x":3516.021553039551,"y":769.5556201934814,"z":"64165859.65c218","wires":[]},{"id":"5cf76218.ae346c","type":"comment","name":"Apply the policy to source network","info":"","comments":"","x":584.0000152587891,"y":928.0000286102295,"z":"64165859.65c218","wires":[]},{"id":"3396a245.5af4be","type":"execute","name":"execute Contrail API apply network policy to destination network","xml":"<execute plugin='org.onap.ccsdk.sli.plugins.contrail.ContrailAdaptor' method='sendContrailRequest' emitsOutcome='true' >\n<parameter name='api-name' value='network-policy' />\n<parameter name='api-action' value='apply' />\n<parameter name='resp-prefix' value='contrailResp' />\n<parameter name='cloud-region-id' value='`$tmp.ar.cloud-region-id`' />\n<parameter name='contrail-network-policy-id' value='`$ar-assignments.contrail-id`' />\n<parameter name='contrail-network-policy-fq-name' value='`$ar-assignments.contrail-fq-name`' />\n<parameter name='contrail-virtual-network-id' value='`$aai.dest-network.contrail-network-fqdn`' />\n\n","comments":"","outputs":1,"x":690.0000610351562,"y":1212.000036239624,"z":"64165859.65c218","wires":[["e17d1029.116eb","5a9c42ae.afc9ac"]]},{"id":"e17d1029.116eb","type":"success","name":"success","xml":"<outcome value='success'>\n","comments":"","outputs":1,"x":1025.6664962768555,"y":1212.4282269477844,"z":"64165859.65c218","wires":[["b46738dd.eae108"]]},{"id":"5a9c42ae.afc9ac","type":"failure","name":"failure","xml":"<outcome value='failure'>\n","comments":"","outputs":1,"x":1023.7618179321289,"y":1245.4281667135656,"z":"64165859.65c218","wires":[["7d2e0a11.918714"]]},{"id":"7d2e0a11.918714","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"500\" />\n    <parameter name=\"error-message\" value=\"Failed to apply policy in Contrail to source network\" />\n","comments":"","x":1183.6665878295898,"y":1244.7615332603455,"z":"64165859.65c218","wires":[]},{"id":"b46738dd.eae108","type":"block","name":"block","xml":"<block>\n","atomic":"false","comments":"","outputs":1,"x":1177.8569793701172,"y":1213.094951953739,"z":"64165859.65c218","wires":[[]]},{"id":"b29978f4.4fd1e8","type":"comment","name":"Apply the policy to dest network","info":"","comments":"","x":588.3861846923828,"y":1180.0528321266174,"z":"64165859.65c218","wires":[]},{"id":"4afec706.648e68","type":"returnSuccess","name":"return success","xml":"<return status='success'>\n<parameter name=\"ack-final-indicator\" value=\"Y\" />\n<parameter name=\"error-code\" value=\"200\" />\n<parameter name=\"error-message\" value=\"`$error-message`\" />\n","comments":"","x":499.0001792907715,"y":2087.9766874313354,"z":"64165859.65c218","wires":[]},{"id":"6e8ca02f.7313","type":"set","name":"set output to api handler","xml":"<set>\n<parameter name='allotted-resource-id' value='`$tmp.ar.allotted-resource-id`' />\n<parameter name='contrail-route-object-path' value=\"`$tmp.ar.self-link`\"/>\n<parameter name='service-object-path' value=\"`'restconf/config/GENERIC-RESOURCE-API:services/service/'\n + $contrail-route-topology-operation-input.service-information.service-instance-id\n + '/service-data/service-topology/'`\"/>\n \n","comments":"","x":527.7540855407715,"y":2050.4324808120728,"z":"64165859.65c218","wires":[]},{"id":"54889c95.317884","type":"set","name":"set allotted-resource-oper-status","xml":"<set>\n<parameter name='ar.allotted-resource-data.allotted-resource-oper-status.order-status' value='Active' />\n<parameter name='ar.allotted-resource-data.allotted-resource-oper-status.last-action' value='`$contrail-route-topology-operation-input.request-information.request-action`' />\n<parameter name='ar.allotted-resource-data.allotted-resource-oper-status.last-rpc-action' value='`$contrail-route-topology-operation-input.sdnc-request-header.svc-action`' />\n<parameter name='ar.allotted-resource-data.allotted-resource-oper-status.last-svc-request-id' value='`$contrail-route-topology-operation-input.sdnc-request-header.svc-request-id`' />\n<parameter name='ar.allotted-resource-data.allotted-resource-oper-status.create-timestamp' value='`$tmp.current-time`' />\n","comments":"","x":559.4209213256836,"y":1909.4800510406494,"z":"64165859.65c218","wires":[]},{"id":"c2672028.9a192","type":"execute","name":"execute RestApiCallNode - PUT AR by id","xml":"<execute plugin='org.onap.ccsdk.sli.plugins.restapicall.RestapiCallNode' method='sendRequest' >\n    <parameter name='templateFileName' value=\"`$prop.restapi.templateDir + '/' + $prop.restapi.cr.templatefile`\" />\n    <parameter name='restapiUrl' value='`$prop.controller.url + $tmp.ar-url`' />\n    <parameter name='restapiUser' value='`$prop.controller.user`' />\n    <parameter name='restapiPassword' value='`$prop.controller.pwd`' />\n    <parameter name='format' value='json' />\n    <parameter name='httpMethod' value='PUT' />\n    <parameter name=\"responsePrefix\" value=\"mdsal-ar\" />\n\n","comments":"","outputs":1,"x":587.5293960571289,"y":1983.529543876648,"z":"64165859.65c218","wires":[["e8a6a664.d79298","eabef186.2a8a8","879fe46c.3b2498"]]},{"id":"e8a6a664.d79298","type":"not-found","name":"not-found","xml":"<outcome value='not-found'>\n","comments":"","outputs":1,"x":857.8374137878418,"y":2036.5277446731925,"z":"64165859.65c218","wires":[["a31c2d71.a08e1"]]},{"id":"eabef186.2a8a8","type":"failure","name":"failure","xml":"<outcome value='failure'>\n","comments":"","outputs":1,"x":848.8374633789062,"y":2005.027770422399,"z":"64165859.65c218","wires":[["a31c2d71.a08e1"]]},{"id":"879fe46c.3b2498","type":"success","name":"success","xml":"<outcome value='success'>\n","comments":"","outputs":1,"x":852.5875015258789,"y":1975.3848752975464,"z":"64165859.65c218","wires":[["bb8e21b5.4f02e"]]},{"id":"a31c2d71.a08e1","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"500\" />\n    <parameter name=\"error-message\" value=\"Error updating md-sal for contrail-route-allotted-resource\" />\n","comments":"","x":1018.5875015258789,"y":2005.777794264257,"z":"64165859.65c218","wires":[]},{"id":"bb8e21b5.4f02e","type":"block","name":"block","xml":"<block>\n","atomic":"false","comments":"","outputs":1,"x":994.2434692382812,"y":1971.5770444869995,"z":"64165859.65c218","wires":[[]]},{"id":"bc559c11.5308","type":"execute","name":"execute getTime","xml":"<execute plugin='org.onap.ccsdk.sli.core.slipluginutils.SliPluginUtils' method='setTime' >\n    <parameter name=\"outputPath\" value=\"tmp.current-time\" />\n\n","comments":"","outputs":1,"x":510.24351501464844,"y":1875.9101829528809,"z":"64165859.65c218","wires":[[]]},{"id":"922d2ffc.4476e","type":"comment","name":"Need to rollback aai here","info":"","comments":"","x":1244.6667633056638,"y":2005.0953893661497,"z":"64165859.65c218","wires":[]},{"id":"876eb57a.485618","type":"comment","name":"Create  network policy in AAI","info":"","comments":"","x":544.0000381469727,"y":1825.0952768325806,"z":"64165859.65c218","wires":[]},{"id":"a6675806.e2dc08","type":"update","name":"update AAI allotted-resource","xml":"<update plugin=\"org.onap.ccsdk.sli.adaptors.aai.AAIService\" \n\t\tresource=\"allotted-resource\" \n\t\tkey=\"customer.global-customer-id = $service-data.service-information.global-customer-id AND\n\t\t\tservice-subscription.service-type = $service-data.service-information.subscription-service-type AND\n\t\t\tservice-instance.service-instance-id = $service-data.service-information.service-instance-id AND\n\t\t\tallotted-resource.id = $tmp.ar.allotted-resource-id\"\n        pfx='pfx' local-only='false' force='false'>\n\t<parameter name=\"operational-status\" value=\"in-service-path\" />\n","comments":"","outputs":1,"x":548.6191101074219,"y":1787.0478992462158,"z":"64165859.65c218","wires":[["b7633a81.cf12d8","475a5176.80fc4"]]},{"id":"b7633a81.cf12d8","type":"failure","name":"failure","xml":"<outcome value='failure'>\n","comments":"","outputs":1,"x":816.3810272216797,"y":1764.2859525680542,"z":"64165859.65c218","wires":[["7dabdf24.12b19"]]},{"id":"475a5176.80fc4","type":"failure","name":"not-found","xml":"<outcome value='not-found'>\n","comments":"","outputs":1,"x":821.6904563903809,"y":1799.857370376587,"z":"64165859.65c218","wires":[["7dabdf24.12b19"]]},{"id":"7dabdf24.12b19","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"500\" />\n    <parameter name=\"error-message\" value=\"AAI failed\" />\n","comments":"","x":1031.4762420654297,"y":1765.9049968719482,"z":"64165859.65c218","wires":[]},{"id":"c82b30e7.1d586","type":"comment","name":"Update AAI AR","info":"","comments":"","x":501.96195220947266,"y":1746.476222038269,"z":"64165859.65c218","wires":[]},{"id":"3de8fec.d2ae202","type":"comment","name":"Update network policy in AAI - relationship to networks","info":"","comments":"","x":652.0001220703125,"y":1452.0000410079956,"z":"64165859.65c218","wires":[]},{"id":"f8a3e8b0.ff98a8","type":"save","name":"save AnAI - network-policy relationship to source and destination network","xml":"<save plugin=\"org.onap.ccsdk.sli.adaptors.aai.AAIService\" \n\tresource=\"network-policy:relationship-list\" \n\tkey=\"network-policy.network-policy-id = $ar-assignments.contrail-id\" >\n<parameter name=\"relationship-list.relationship[0].related-to\" value=\"l3-network\" />\n<parameter name=\"relationship-list.relationship[0].related-link\" value=\"`tmp.AnAI-src.related-link`\" />\n<parameter name=\"relationship-list.relationship[1].related-to\" value=\"l3-network\" />\n<parameter name=\"relationship-list.relationship[1].related-link\" value=\"`tmp.AnAI-dest.related-link`\" />\n\n\n","comments":"","outputs":1,"x":713.3770179748535,"y":1489.0675249099731,"z":"64165859.65c218","wires":[["f4eee49b.3eb418","96306b55.89f5d8"]]},{"id":"930748bb.7c87d8","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"500\" />\n    <parameter name=\"error-message\" value=\"Failed to save network policy in AAI\" />\n","comments":"","x":1357.7225036621094,"y":1485.3494877815247,"z":"64165859.65c218","wires":[]},{"id":"f4eee49b.3eb418","type":"failure","name":"failure","xml":"<outcome value='failure'>\n","comments":"","outputs":1,"x":1129.1511116027832,"y":1488.365225315094,"z":"64165859.65c218","wires":[["930748bb.7c87d8"]]},{"id":"96306b55.89f5d8","type":"not-found","name":"not-found","xml":"<outcome value='not-found'>\n","comments":"","outputs":1,"x":1132.9606094360352,"y":1516.8416419029236,"z":"64165859.65c218","wires":[["930748bb.7c87d8"]]},{"id":"f2b08893.418cf8","type":"save","name":"get related-link data for source network","xml":"<get-resource plugin=\"com.att.sdnctl.sli.aai.AAIService\"\nresource=\"related-link\"\nkey=\"l3-network.network-id = $ar.allotted-resource-data.contrail-route-topology.contrail-route-assignments.source-network.network-id\"\nlocal-only=\"true\"\npfx=\"tmp.AnAI-src\">\n\n\n\n","comments":"","outputs":1,"x":618.0000152587891,"y":1286.0000371932983,"z":"64165859.65c218","wires":[["1752b575.8c8cbb","cdbec68d.a55978"]]},{"id":"1398e1ba.93427e","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"500\" />\n    <parameter name=\"error-message\" value=\"Failed to get related link for l3-network in AAI\" />\n","comments":"","x":1262,"y":1292,"z":"64165859.65c218","wires":[]},{"id":"1752b575.8c8cbb","type":"failure","name":"failure","xml":"<outcome value='failure'>\n","comments":"","outputs":1,"x":1033.4286079406738,"y":1291.0157375335693,"z":"64165859.65c218","wires":[["1398e1ba.93427e"]]},{"id":"cdbec68d.a55978","type":"not-found","name":"not-found","xml":"<outcome value='not-found'>\n","comments":"","outputs":1,"x":1037.2381057739258,"y":1320.492154121399,"z":"64165859.65c218","wires":[["1398e1ba.93427e"]]},{"id":"f43488c4.18e4b8","type":"save","name":"get related-link data for dest network","xml":"<get-resource plugin=\"com.att.sdnctl.sli.aai.AAIService\"\nresource=\"related-link\"\nkey=\"l3-network.network-id = $ar.allotted-resource-data.contrail-route-topology.contrail-route-assignments.dest-network.network-id\"\nlocal-only=\"true\"\npfx=\"tmp.AnAI-dest\">\n\n\n\n","comments":"","outputs":1,"x":614,"y":1360,"z":"64165859.65c218","wires":[["91989618.fd4e18","fa09c5bd.ae5068"]]},{"id":"7b92823a.91cf8c","type":"returnFailure","name":"return failure","xml":"<return status='failure'>\n\t<parameter name='ack-final' value='Y'/>\n\t<parameter name=\"error-code\" value=\"500\" />\n    <parameter name=\"error-message\" value=\"Failed to get related link for l3-network in AAI\" />\n","comments":"","x":1056.0000381469727,"y":1370.0000410079956,"z":"64165859.65c218","wires":[]},{"id":"91989618.fd4e18","type":"failure","name":"failure","xml":"<outcome value='failure'>\n","comments":"","outputs":1,"x":873.4286422729492,"y":1357.0157642364502,"z":"64165859.65c218","wires":[["7b92823a.91cf8c"]]},{"id":"fa09c5bd.ae5068","type":"not-found","name":"not-found","xml":"<outcome value='not-found'>\n","comments":"","outputs":1,"x":879.2381210327148,"y":1386.4922285079956,"z":"64165859.65c218","wires":[["7b92823a.91cf8c"]]}]
