<service-logic xmlns='http://www.openecomp.org/sdnc/svclogic' xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xsi:schemaLocation='http://www.openecomp.org/sdnc/svclogic ./svclogic.xsd' module='VNF-API' version='${project.version}'><method rpc='vnf-topology-automated-delete' mode='sync'>
<block atomic="true"><switch test="`$vnf-topology-operation-input.vnf-request-information.vnf-id == $service-data.vnf-id`"><outcome value='false'>
<return status='failure'>
	<parameter name='error-code' value='404'/>
	<parameter name='error-message' value='vnf-id not found'/></return></outcome></switch><switch test="`$service-data.oper-status.order-status == Active`"><outcome value='false'><return status='failure'>
	<parameter name='error-code' value='400'/>
	<parameter name='error-message' value='Invalid order-status'/></return></outcome></switch><set>
	<parameter name="service-data.oper-status.last-order-status" value="`$service-data.oper-status.order-status`"/></set><set>
	<parameter name="service-data.oper-status.last-action" value="`$service-data.request-information.request-action`"/></set><switch test="`$vnf-topology-operation-input.request-information.request-sub-action`">
<!--
leaf request-sub-action {
	type enumeration {
		enum "SUPP";
        enum "CANCEL";
        enum "RetainResource";
	}
}
-->

<outcome value='RetainResource'><block atomic="true"><set>
	<parameter name="service-data.oper-status.order-status" value="PendingDelete"/></set><update plugin="org.openecomp.sdnc.sli.aai.AAIService" 
	resource="vf-module" 
		key="vf-module.vf-module-id = $vnf-topology-operation-input.vnf-request-information.vnf-id 
			AND generic-vnf.vnf-id = $vnf-topology-operation-input.vnf-request-information.generic-vnf-id" 
		local-only="false" >
	<parameter name="orchestration-status" value="pending-delete" /><outcome value='failure'>
<return status='failure'>
	<parameter name='error-code' value='500'/>
	<parameter name='error-message' value="`'Encountered error while updating vf-module orchestration-status in AnAI with vnf-id = ' + $vnf-topology-operation-input.vnf-request-information.vnf-id + ' and generic-vnf-id = ' + $vnf-topology-operation-input.vnf-request-information.generic-vnf-id`"/></return></outcome></update></block></outcome><outcome value=''><block atomic='true'><set>
	<parameter name="service-data.oper-status.order-status" value="Deleted"/></set><call module='VNF-API' rpc='rollback-eipam-ip-assignment' mode='sync' ></call><switch test="`$service-data.vnf-topology-information.vnf-assignments.vnf-vms_length`">
<outcome value=''><set>
	<parameter name="service-data.vnf-topology-information.vnf-assignments.vnf-vms_length" value="0" /></set></outcome></switch><for index='i' start='0' end='`$service-data.vnf-topology-information.vnf-assignments.vnf-vms_length`' ><block atomic="true"><switch test="`$service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names_length`">
<outcome value=''><set>
	<parameter name="service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names_length" value="0" /></set></outcome></switch><for index='j' start='0' end='`$service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names_length`' ><block atomic="true"><switch test="`$service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names[$j].vnfc-names_length`">
<outcome value=''><set>
	<parameter name="service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names[$j].vnfc-names_length" value="0" /></set></outcome></switch><for index='k' start='0' end='`$service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names[$j].vnfc-names_length`' ><delete plugin="org.openecomp.sdnc.sli.aai.AAIService" 
	resource="vnfc" 
		key="vnfc.vnfc-name = $service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names[$j].vnfc-names[$k].vnfc-name" > <outcome value='failure'>
<return status='failure'>
	<parameter name='error-code' value='500'/>
	<parameter name='error-message' value="`'Encountered error while rolling back vnfc object' + $service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names[$j].vnfc-names[$k].vnfc-name + ' from AnAI. MANUAL rollback is required!'`"/></return></outcome></delete></for></block></for></block></for><set>
	<parameter name="service-data." value="" /> 
</set></block></outcome><outcome value='other'><block atomic='true'><set>
	<parameter name="service-data.oper-status.order-status" value="Deleted"/></set><call module='VNF-API' rpc='rollback-eipam-ip-assignment' mode='sync' ></call><switch test="`$service-data.vnf-topology-information.vnf-assignments.vnf-vms_length`">
<outcome value=''><set>
	<parameter name="service-data.vnf-topology-information.vnf-assignments.vnf-vms_length" value="0" /></set></outcome></switch><for index='i' start='0' end='`$service-data.vnf-topology-information.vnf-assignments.vnf-vms_length`' ><block atomic="true"><switch test="`$service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names_length`">
<outcome value=''><set>
	<parameter name="service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names_length" value="0" /></set></outcome></switch><for index='j' start='0' end='`$service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names_length`' ><block atomic="true"><switch test="`$service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names[$j].vnfc-names_length`">
<outcome value=''><set>
	<parameter name="service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names[$j].vnfc-names_length" value="0" /></set></outcome></switch><for index='k' start='0' end='`$service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names[$j].vnfc-names_length`' ><delete plugin="org.openecomp.sdnc.sli.aai.AAIService" 
	resource="vnfc" 
		key="vnfc.vnfc-name = $service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names[$j].vnfc-names[$k].vnfc-name" > <outcome value='failure'>
<return status='failure'>
	<parameter name='error-code' value='500'/>
	<parameter name='error-message' value="`'Encountered error while rolling back vnfc object' + $service-data.vnf-topology-information.vnf-assignments.vnf-vms[$i].vm-names[$j].vnfc-names[$k].vnfc-name + ' from AnAI. MANUAL rollback is required!'`"/></return></outcome></delete></for></block></for></block></for><set>
	<parameter name="service-data." value="" /> 
</set></block></outcome></switch><set>
	<parameter name="service-data." value="vnf-topology-operation-input." /></set><set>
<parameter name="ack-final" value="Y"/></set></block></method></service-logic>